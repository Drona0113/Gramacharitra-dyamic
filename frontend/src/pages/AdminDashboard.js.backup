import React, { useState, useEffect, useCallback } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAdmin } from '../context/AdminContext';
import api from '../services/api';
import { 
  FaSignOutAlt, FaPlus, FaEdit, FaUsers, FaTrash,
  FaChartLine, FaCog, FaBell, FaSearch, FaHome, 
  FaMapMarkedAlt, FaUserCog, FaHistory, FaInfoCircle,
  FaChevronRight, FaUserPlus, FaSync, FaFilter,
  FaUserShield, FaChartBar, FaTable, FaDownload, FaUserEdit,
  FaUsersCog, FaChartPie, FaServer, FaShieldAlt, FaUserCheck
} from 'react-icons/fa';
import { motion, AnimatePresence } from 'framer-motion';
import { toast } from 'react-toastify';
import 'react-toastify/dist/ReactToastify.css';
import './AdminDashboard.css';

// Chart.js components
import { Bar, Line, Doughnut } from 'react-chartjs-2';
import {
  Chart as ChartJS,
  CategoryScale,
  LinearScale,
  BarElement,
  LineElement,
  PointElement,
  ArcElement,
  Title,
  Tooltip,
  Legend,
  Filler
} from 'chart.js';

// Register ChartJS components
ChartJS.register(
  CategoryScale,
  LinearScale,
  BarElement,
  LineElement,
  PointElement,
  ArcElement,
  Title,
  Tooltip,
  Legend,
  Filler
);

const AdminDashboard = () => {
  const { adminUser, logoutAdmin } = useAdmin();
  const navigate = useNavigate();
  
  // States
  const [stats, setStats] = useState({
    totalVillages: 0,
    activeUsers: 0,
    pendingTasks: 0,
    recentActivity: [],
    userStats: {
      total: 0,
      active: 0,
      inactive: 0,
      roles: {}
    },
    villageStats: {
      total: 0,
      active: 0,
      inactive: 0,
      byRegion: {}
    },
    systemStats: {
      uptime: '99.9%',
      responseTime: '120ms',
      lastUpdated: new Date().toISOString()
    }
  });

  // Real-time data state
  const [realTimeData, setRealTimeData] = useState({
    usersOnline: 0,
    activeSessions: 0,
    systemStatus: 'operational',
    lastUpdated: new Date().toISOString()
  });

  // Chart data state
  const [chartData, setChartData] = useState({
    userActivity: null,
    villageDistribution: null,
    systemLoad: null
  });

  const [villages, setVillages] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);
  const [searchQuery, setSearchQuery] = useState('');
  const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [showLogoutConfirm, setShowLogoutConfirm] = useState(false);
  
  // Mock notifications
  const [notifications, setNotifications] = useState([
    { id: 1, message: 'New village added: Kothapet', time: '2 hours ago', read: false, type: 'success' },
    { id: 2, message: 'User registration: John Doe', time: '5 hours ago', read: true, type: 'info' },
    { id: 3, message: 'System update available', time: '1 day ago', read: true, type: 'warning' }
  ]);

  useEffect(() => {
    fetchDashboardData();
  }, []);

  const fetchDashboardData = useCallback(async () => {
    setIsLoading(true);
    try {
      // Fetch villages data
      const villagesResponse = await api.get('/villages');
      const villagesData = Array.isArray(villagesResponse?.data) ? villagesResponse.data : [];
      
      // Fetch users data (mock for now)
      const mockUsers = [
        { id: 1, name: 'Admin User', email: 'admin@example.com', role: 'admin', status: 'active' },
        { id: 2, name: 'Editor User', email: 'editor@example.com', role: 'editor', status: 'active' },
        { id: 3, name: 'Viewer User', email: 'viewer@example.com', role: 'viewer', status: 'inactive' },
      ];

      // Calculate statistics
      const activeUsers = mockUsers.filter(user => user.status === 'active').length;
      const inactiveUsers = mockUsers.filter(user => user.status === 'inactive').length;
      
      // Update stats
      setStats({
        totalVillages: villagesData.length,
        activeUsers,
        pendingTasks: Math.floor(Math.random() * 10), // Mock data
        recentActivity: (villagesData.slice(0, 5) || []).map(village => ({
          ...village,
          action: 'Updated',
          time: new Date().toISOString()
        })),
        userStats: {
          total: mockUsers.length,
          active: activeUsers,
          inactive: inactiveUsers,
          roles: {
            admin: mockUsers.filter(u => u.role === 'admin').length,
            editor: mockUsers.filter(u => u.role === 'editor').length,
            viewer: mockUsers.filter(u => u.role === 'viewer').length
          }
        },
        villageStats: {
          total: villagesData.length,
          active: Math.floor(villagesData.length * 0.8), // 80% active
          inactive: Math.ceil(villagesData.length * 0.2), // 20% inactive
          byRegion: villagesData.reduce((acc, village) => {
            const region = village.region || 'Unknown';
            acc[region] = (acc[region] || 0) + 1;
            return acc;
          }, {})
        },
        systemStats: {
          uptime: '99.9%',
          responseTime: `${Math.floor(Math.random() * 100) + 50}ms`,
          lastUpdated: new Date().toISOString()
        }
      });

      // Update real-time data
      setRealTimeData({
        usersOnline: Math.floor(Math.random() * 50) + 1,
        activeSessions: Math.floor(Math.random() * 100) + 10,
        systemStatus: 'operational',
        lastUpdated: new Date().toISOString()
      });

      // Prepare chart data
      const userActivityData = {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [
          {
            label: 'Active Users',
            data: [12, 19, 3, 5, 2, 3, 8],
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1,
            tension: 0.4,
            fill: true
          }
        ]
      };

      const villageDistributionData = {
        labels: Object.keys(villagesData.reduce((acc, v) => {
          const region = v.region || 'Unknown';
          acc[region] = true;
          return acc;
        }, {})),
        datasets: [{
          data: Object.values(villagesData.reduce((acc, v) => {
            const region = v.region || 'Unknown';
            acc[region] = (acc[region] || 0) + 1;
            return acc;
          }, {})),
          backgroundColor: [
            'rgba(255, 99, 132, 0.7)',
            'rgba(54, 162, 235, 0.7)',
            'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)',
            'rgba(153, 102, 255, 0.7)',
          ],
          borderWidth: 1
        }]
      };

      setChartData({
        userActivity: userActivityData,
        villageDistribution: villageDistributionData,
        systemLoad: {
          labels: ['CPU', 'Memory', 'Disk', 'Network'],
          datasets: [{
            data: [65, 45, 30, 80],
            backgroundColor: [
              'rgba(255, 99, 132, 0.7)',
              'rgba(54, 162, 235, 0.7)',
              'rgba(255, 206, 86, 0.7)',
              'rgba(75, 192, 192, 0.7)'
            ]
          }]
        }
      });
    } catch (error) {
      console.error('Error fetching dashboard data:', error);
      setError('Failed to load dashboard data. Please try again later.');
      toast.error('Failed to load dashboard data');
      
      // Reset states on error
      setVillages([]);
      setStats({
        totalVillages: 0,
        activeUsers: 0,
        pendingTasks: 0,
        recentActivity: [],
        userStats: { total: 0, active: 0, inactive: 0, roles: {} },
        villageStats: { total: 0, active: 0, inactive: 0, byRegion: {}},
        systemStats: { uptime: '0%', responseTime: 'N/A', lastUpdated: new Date().toISOString() }
      });
      
      setRealTimeData({
        usersOnline: 0,
        activeSessions: 0,
        systemStatus: 'error',
        lastUpdated: new Date().toISOString()
      });
    } finally {
      setIsLoading(false);
    }
  }, []);

  const handleLogout = async () => {
    try {
      await logoutAdmin();
      navigate('/');
    } catch (error) {
      console.error('Logout error:', error);
    }
  };

  const toggleSidebar = () => {
    setIsSidebarCollapsed(!isSidebarCollapsed);
  };

  const markNotificationAsRead = (id) => {
    setNotifications(notifications.map(notif => 
      notif.id === id ? { ...notif, read: true } : notif
    ));
  };

  const unreadNotifications = notifications.filter(n => !n.read).length;
  
  // Quick actions
  const quickActions = [
    {
      id: 'add-village',
      icon: <FaPlus />,
      label: 'Add Village',
      onClick: () => navigate('/admin/villages/add'),
      variant: 'primary',
      description: 'Add a new village to the system'
    },
    {
      id: 'manage-users',
      icon: <FaUserCog />,
      label: 'Manage Users',
      onClick: () => navigate('/admin/users'),
      variant: 'secondary',
      description: 'View and manage user accounts'
    },
    {
      id: 'reports',
      icon: <FaChartLine />,
      label: 'View Reports',
      onClick: () => navigate('/admin/reports'),
      variant: 'tertiary',
      description: 'Generate and view system reports'
    },
    {
      id: 'settings',
      icon: <FaCog />,
      label: 'Settings',
      onClick: () => navigate('/admin/settings'),
      variant: 'quaternary',
      description: 'Configure system settings'
    }
  ];
  
  // Handle tab change
  const handleTabChange = (tab) => {
    setActiveTab(tab);
    // Scroll to top when changing tabs
    window.scrollTo(0, 0);
    
    // Add tab-specific logic
    switch(tab) {
      case 'dashboard':
        fetchDashboardData();
        break;
      case 'villages':
        // Fetch villages data
        break;
      case 'users':
        // Fetch users data
        break;
      case 'settings':
        // Fetch settings
        break;
      default:
        break;
    }
  };
  
  // Handle search submit
  const handleSearchSubmit = (e) => {
    e.preventDefault();
    if (searchQuery.trim()) {
      toast.info(`Searching for: ${searchQuery}`);
      // You can add search logic here
    }
  };
  
  // Handle logout confirmation
  const confirmLogout = () => {
    setShowLogoutConfirm(true);
  };
  
  // Handle cancel logout
  const cancelLogout = () => {
    setShowLogoutConfirm(false);
  };

  // Format date to readable format
  const formatDate = (dateString) => {
    const options = { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric',
      hour: '2-digit', 
      minute: '2-digit' 
    };
    return new Date(dateString).toLocaleDateString(undefined, options);
  };

  // Get status badge class
  const getStatusBadgeClass = (status) => {
    switch(status.toLowerCase()) {
      case 'active':
        return 'status-badge status-active';
      case 'inactive':
        return 'status-badge status-inactive';
      case 'pending':
        return 'status-badge status-pending';
      default:
        return 'status-badge';
    }
  };

  return (
    <div className={`admin-dashboard ${isSidebarCollapsed ? 'sidebar-collapsed' : ''}`}>
      {/* Sidebar */}
      <motion.div 
        className="sidebar"
        initial={{ x: -300 }}
        animate={{ x: 0 }}
        transition={{ type: 'spring', stiffness: 300, damping: 30 }}
      >
        <div className="sidebar-header">
          <motion.div 
            className="logo"
            whileHover={{ scale: 1.05 }}
            whileTap={{ scale: 0.95 }}
          >
            <FaMapMarkedAlt className="logo-icon" />
            {!isSidebarCollapsed && <h2>Grama Charitra</h2>}
          </motion.div>
          <button className="toggle-sidebar" onClick={toggleSidebar}>
            {isSidebarCollapsed ? '‚Üí' : '‚Üê'}
          </button>
        </div>
        <p>Admin Panel</p>
        <nav className="sidebar-nav">
          <button className="nav-item active" onClick={() => setActiveTab('dashboard')}>
            <FaChartLine className="nav-icon" />
            <span>Dashboard</span>
          </button>
          <button className="nav-item" onClick={() => setActiveTab('villages')}>
            <FaUsers className="nav-icon" />
            <span>Villages</span>
          </button>
          <button className="nav-item" onClick={() => setActiveTab('settings')}>
            <FaCog className="nav-icon" />
            <span>Settings</span>
          </button>
        </nav>
        <ul className="sidebar-menu">
          <li 
            className={`menu-item ${activeTab === 'dashboard' ? 'active' : ''}`}
            onClick={() => setActiveTab('dashboard')}
          >
            <FaHome className="menu-icon" />
            {!isSidebarCollapsed && <span>Dashboard</span>}
          </li>
          <li 
            className={`menu-item ${activeTab === 'villages' ? 'active' : ''}`}
            onClick={() => setActiveTab('villages')}
          >
            <FaMapMarkedAlt className="menu-icon" />
            {!isSidebarCollapsed && <span>Villages</span>}
          </li>
          <li 
            className={`menu-item ${activeTab === 'users' ? 'active' : ''}`}
            onClick={() => setActiveTab('users')}
          >
            <FaUsers className="menu-icon" />
            {!isSidebarCollapsed && <span>Users</span>}
          </li>
          <li 
            className={`menu-item ${activeTab === 'settings' ? 'active' : ''}`}
            onClick={() => setActiveTab('settings')}
          >
            <FaCog className="menu-icon" />
            {!isSidebarCollapsed && <span>Settings</span>}
          </li>
        </ul>

        <div className="sidebar-footer">
          <button className="logout-btn" onClick={handleLogout}>
            <FaSignOutAlt className="logout-icon" />
            {!isSidebarCollapsed && <span>Logout</span>}
          </button>
        </div>
      </motion.div>

      {/* Main Content */}
      <div className="main-content">
        {/* Top Bar */}
        <header className="top-bar">
          <div className="search-bar">
            <FaSearch className="search-icon" />
            <input 
              type="text" 
              placeholder="Search..." 
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
            />
          </div>
          
          <div className="top-bar-actions">
            <div className="notifications">
              <div className="notification-icon">
                <FaBell />
                {unreadNotifications > 0 && (
                  <span className="notification-badge">{unreadNotifications}</span>
                )}
              </div>
              <div className="notification-dropdown">
                <h4>Notifications</h4>
                {notifications.length > 0 ? (
                  <div className="notification-list">
                    {notifications.map(notification => (
                      <div 
                        key={notification.id} 
                        className={`notification-item ${notification.read ? 'read' : 'unread'}`}
                        onClick={() => markNotificationAsRead(notification.id)}
                      >
                        <p>{notification.message}</p>
                        <span className="notification-time">{notification.time}</span>
                      </div>
                    ))}
                  </div>
                ) : (
                  <p className="no-notifications">No new notifications</p>
                )}
              </div>
            </div>
            
            <div className="user-profile">
              <div className="avatar">
                {adminUser?.name?.charAt(0) || 'A'}
              </div>
              <div className="user-info">
                <h4>{adminUser?.name || 'Admin'}</h4>
                <p>Administrator</p>
              </div>
            </div>
          </div>
        </header>

        {/* Dashboard Content */}
        <main className="dashboard-content">
          {/* Welcome Section */}
          <section className="welcome-section">
            <motion.div 
              className="welcome-card"
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              transition={{ delay: 0.2 }}
            >
              <h1>Welcome back, {adminUser?.name?.split(' ')[0] || 'Admin'}! üëã</h1>
              <p>Here's what's happening with your villages today.</p>
            </motion.div>
          </section>

          {/* Stats Grid */}
          <section className="stats-grid">
            <motion.div 
              className="stat-card"
              whileHover={{ y: -5, boxShadow: '0 10px 20px rgba(0,0,0,0.1)' }}
            >
              <div className="stat-icon">
                <FaMapMarkedAlt />
              </div>
              <div className="stat-info">
                <h3>{stats.totalVillages}</h3>
                <p>Total Villages</p>
              </div>
            </motion.div>

            <motion.div 
              className="stat-card"
              whileHover={{ y: -5, boxShadow: '0 10px 20px rgba(0,0,0,0.1)' }}
            >
              <div className="stat-icon users">
                <FaUsers />
              </div>
              <div className="stat-info">
                <h3>{stats.activeUsers}</h3>
                <p>Active Users</p>
              </div>
            </motion.div>

            <motion.div 
              className="stat-card"
              whileHover={{ y: -5, boxShadow: '0 10px 20px rgba(0,0,0,0.1)' }}
            >
              <div className="stat-icon tasks">
                <FaChartLine />
              </div>
              <div className="stat-info">
                <h3>{stats.pendingTasks}</h3>
                <p>Pending Tasks</p>
              </div>
            </motion.div>
          </section>

          {/* Recent Activity & Quick Actions */}
          <section className="dashboard-row">
            {/* Recent Villages */}
            <motion.div 
              className="dashboard-card"
              initial={{ opacity: 0, x: -20 }}
              animate={{ opacity: 1, x: 0 }}
              transition={{ delay: 0.3 }}
            >
              <div className="card-header">
                <h3>Recent Villages</h3>
                <button className="view-all">View All</button>
              </div>
              <div className="village-list">
                {isLoading ? (
                  <div className="loading-state">
                    <div className="loading-spinner"></div>
                    <p>Loading villages...</p>
                  </div>
                ) : error ? (
                  <div className="error-state">
                    <FaInfoCircle className="error-icon" />
                    <p>{error}</p>
                    <button 
                      className="retry-btn"
                      onClick={fetchDashboardData}
                    >
                      Retry
                    </button>
                  </div>
                ) : villages && villages.length > 0 ? (
                  (villages || []).slice(0, 5).map((village, index) => {
                    // Skip rendering if village is not properly defined
                    if (!village || typeof village !== 'object') return null;
                    
                    const firstChar = village?.name ? village.name.charAt(0).toUpperCase() : 'V';
                    const villageName = village?.name || 'Unnamed Village';
                    const villageDistrict = village?.district || 'No district specified';
                    const villageId = village?._id || `village-${index}`;
                    
                    return (
                      <motion.div 
                        key={villageId}
                        className="village-item"
                        initial={{ opacity: 0, y: 10 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{ delay: 0.1 * index }}
                      >
                        <div className="village-avatar">
                          {firstChar}
                        </div>
                        <div className="village-info">
                          <h4>{villageName}</h4>
                          <p>{villageDistrict}</p>
                        </div>
                        <button className="village-action">
                          <FaChevronRight />
                        </button>
                      </motion.div>
                    );
                  })
                ) : (
                  <div className="no-data">
                    <FaInfoCircle />
                    <p>No villages found. Add your first village to get started.</p>
                  </div>
                )}
                {!isLoading && !error && villages.length === 0 && (
                  <div className="no-data">
                    <FaInfoCircle />
                    <p>No villages found. Add your first village to get started.</p>
                  </div>
                )}
              </div>
            </motion.div>

            {/* Quick Actions */}
            <motion.div 
              className="dashboard-card quick-actions"
              initial={{ opacity: 0, x: 20 }}
              animate={{ opacity: 1, x: 0 }}
              transition={{ delay: 0.3 }}
            >
              <div className="card-header">
                <h3>Quick Actions</h3>
              </div>
              <div className="action-buttons">
                <motion.button 
                  className="action-btn primary"
                  whileHover={{ scale: 1.03 }}
                  whileTap={{ scale: 0.98 }}
                  onClick={() => navigate('/admin/add-village')}
                >
                  <FaPlus className="btn-icon" />
                  <span>Add New Village</span>
                </motion.button>
                
                <motion.button 
                  className="action-btn secondary"
                  whileHover={{ scale: 1.03 }}
                  whileTap={{ scale: 0.98 }}
                  onClick={() => navigate('/admin/villages')}
                >
                  <FaEdit className="btn-icon" />
                  <span>Manage Villages</span>
                </motion.button>
                
                <motion.button 
                  className="action-btn tertiary"
                  whileHover={{ scale: 1.03 }}
                  whileTap={{ scale: 0.98 }}
                  onClick={() => navigate('/admin/users')}
                >
                  <FaUserCog className="btn-icon" />
                  <span>User Management</span>
                </motion.button>
                
                <motion.button 
                  className="action-btn quaternary"
                  whileHover={{ scale: 1.03 }}
                  whileTap={{ scale: 0.98 }}
                  onClick={() => navigate('/admin/activity')}
                >
                  <FaHistory className="btn-icon" />
                  <span>View Activity Log</span>
                </motion.button>
              </div>
            </motion.div>
          </section>

          {/* Recent Activity */}
          <motion.section 
            className="recent-activity"
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.4 }}
          >
            <div className="dashboard-card">
              <div className="card-header">
                <h3>Recent Activity</h3>
                <button className="view-all">View All</button>
              </div>
              <div className="activity-list">
                {stats.recentActivity.length > 0 ? (
                  stats.recentActivity.map((activity, index) => (
                    <div key={index} className="activity-item">
                      <div className="activity-icon">
                        <FaMapMarkedAlt />
                      </div>
                      <div className="activity-details">
                        <p><strong>{activity.name}</strong> was {activity.action?.toLowerCase() || 'updated'}</p>
                        <span className="activity-time">
                          {new Date(activity.time).toLocaleString()}
                        </span>
                      </div>
                    </div>
                  ))
                ) : (
                  <div className="no-data">
                    <FaInfoCircle />
                    <p>No recent activity to display</p>
                  </div>
                )}
              </div>
            </div>
          </motion.section>
        </main>

        {/* Footer */}
        <footer className="dashboard-footer">
          <p> Grama Charitra. All rights reserved.</p>
          <div className="footer-links">
            <button className="footer-link">Privacy Policy</button>
            <button className="footer-link">Terms of Service</button>
            <button className="footer-link">Help Center</button>
          </div>
        </footer>
      </div>
    </div>
  );
};

export default AdminDashboard;